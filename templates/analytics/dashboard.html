{% extends 'base.html' %}
{% load analytics_filters %}

{% block title %}Analytics Dashboard | Clean Uganda{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-green-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Page Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                ðŸ“Š Analytics Dashboard
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                Comprehensive insights into waste management activities and platform performance
            </p>
        </div>

        <!-- Date Filter -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <form method="get" class="flex flex-col md:flex-row gap-4 items-center justify-center">
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" name="start_date" value="{{ start_date }}"
                            class="w-full md:w-48 border-2 border-blue-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" name="end_date" value="{{ end_date }}"
                            class="w-full md:w-48 border-2 border-blue-300 rounded-lg shadow-sm p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200" />
                    </div>
                </div>
                <button type="submit"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 shadow-lg mt-4 md:mt-0">
                    Apply Filter
                </button>
            </form>
        </div>

        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-list text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Total Listings</h3>
                        <p class="text-3xl font-bold text-gray-900">{{ total_listings }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-handshake text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Successful Matches</h3>
                        <p class="text-3xl font-bold text-gray-900">{{ matches }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <div class="bg-purple-100 p-3 rounded-lg mr-4">
                        <i class="fas fa-book text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Resource Views</h3>
                        <p class="text-3xl font-bold text-gray-900">{{ resource_views }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Total Quantities by Waste Type -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-weight-hanging text-blue-600 mr-3"></i>
                    Total Quantities by Waste Type
                </h3>

                {% if quantity_by_type_unit %}
                    <div class="space-y-4">
                        {% for waste_type, units in quantity_by_type_unit.items %}
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-800 mb-3">{{ waste_type|title }}</h4>
                                <div class="space-y-2">
                                    {% for unit, total in units.items %}
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-600">{{ unit|title }}</span>
                                            <span class="font-semibold text-blue-700">{{ total|floatformat:2 }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">No quantities available for the selected period.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Products Made -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-recycle text-green-600 mr-3"></i>
                    Products Created
                </h3>
                
                {% if products_made %}
                    <div class="space-y-3">
                        {% for waste_type, product in products_made.items %}
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                                <span class="font-medium text-gray-700">{{ waste_type|title }}</span>
                                <span class="text-green-700 font-semibold">{{ product }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <i class="fas fa-industry text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">No product data available.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Listings by Waste Type Chart -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mt-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-chart-bar text-purple-600 mr-3"></i>
                Listings Distribution by Waste Type
            </h3>

            {% if chart_labels %}
                <div class="chart-container" style="position: relative; height: 400px;">
                    <canvas id="wasteChart"></canvas>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const ctx = document.getElementById('wasteChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: {{ chart_labels|safe }},
                                datasets: [{
                                    label: 'Number of Listings',
                                    data: {{ chart_data|safe }},
                                    backgroundColor: [
                                        '#3B82F6', '#10B981', '#EF4444', '#F59E0B',
                                        '#8B5CF6', '#06B6D4', '#84CC16', '#F97316',
                                        '#6366F1', '#EC4899'
                                    ],
                                    borderColor: [
                                        '#1D4ED8', '#047857', '#DC2626', '#D97706',
                                        '#7C3AED', '#0E7490', '#65A30D', '#EA580C',
                                        '#4F46E5', '#DB2777'
                                    ],
                                    borderWidth: 2,
                                    borderRadius: 8,
                                    borderSkipped: false,
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleFont: {
                                            size: 14
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        padding: 12,
                                        cornerRadius: 8
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        },
                                        ticks: {
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            font: {
                                                size: 12
                                            }
                                        }
                                    }
                                },
                                animation: {
                                    duration: 2000,
                                    easing: 'easeOutQuart'
                                }
                            }
                        });
                    });
                </script>
            {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-chart-line text-gray-400 text-4xl mb-3"></i>
                    <p class="text-gray-500">No chart data available for the selected date range.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
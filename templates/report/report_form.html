{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 py-8">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">Report Illegal Dumping</h1>
            <p class="text-gray-600 mb-2">Help keep Uganda clean by reporting illegal dumping sites</p>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
                <p class="font-semibold">üóëÔ∏è No account needed! Report anonymously if you prefer.</p>
            </div>
        </div>

        <!-- Report Form -->
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <!-- Anonymous Reporter Information -->
                <div class="border-b border-gray-200 pb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Your Information (Optional)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                            {{ form.reporter_name }}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Email</label>
                            {{ form.reporter_email }}
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Your Phone</label>
                            {{ form.reporter_phone }}
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">This information is optional and will only be used if authorities need to contact you.</p>
                </div>

                <!-- Dumping Details -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-gray-800">Dumping Details</h3>
                    
                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo Evidence *</label>
                        <div class="mt-1 flex items-center">
                            {{ form.photo }}
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Please upload a clear photo of the dumping site (max 5MB)</p>
                        {% if form.photo.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.photo.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Waste Type and District -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Waste Type *</label>
                            {{ form.waste_type }}
                            {% if form.waste_type.errors %}
                                <div class="text-red-600 text-sm mt-1">
                                    {% for error in form.waste_type.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">District *</label>
                            {{ form.district }}
                            {% if form.district.errors %}
                                <div class="text-red-600 text-sm mt-1">
                                    {% for error in form.district.errors %}
                                        <p>{{ error }}</p>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Map for Location Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Location on Map *</label>
                        
                        <!-- Location Help Card -->
                        <div id="location-help" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                            <div class="flex items-start">
                                <span class="text-yellow-600 text-lg mr-2">üí°</span>
                                <div>
                                    <p class="text-yellow-800 font-medium">How to select location:</p>
                                    <ul class="text-yellow-700 text-sm mt-1 space-y-1">
                                        <li>‚Ä¢ <strong>Option 1:</strong> Click directly on the map where the dumping occurred</li>
                                        <li>‚Ä¢ <strong>Option 2:</strong> Use "My Current Location" if you're at the site (requires location permission)</li>
                                        <li>‚Ä¢ <strong>Option 3:</strong> Search for a place in the search box above the map</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <button type="button" id="use-current-location" class="bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-2 rounded-md mb-2">
                                üìç Use My Current Location
                            </button>
                            <button type="button" id="reset-location" class="bg-gray-500 hover:bg-gray-600 text-white text-sm px-4 py-2 rounded-md mb-2 ml-2">
                                üó∫Ô∏è Reset to Kampala
                            </button>
                            <button type="button" id="location-help-btn" class="bg-purple-500 hover:bg-purple-600 text-white text-sm px-4 py-2 rounded-md mb-2 ml-2">
                                ‚ùì Location Help
                            </button>
                        </div>

                        <!-- Search Box -->
                        

                        <div id="map" class="w-full h-96 rounded-lg border border-gray-300 mb-2"></div>
                        
                        <div class="flex items-center space-x-4 text-sm">
                            <span id="selected-location" class="text-gray-600">Click on the map to select location</span>
                            <span id="location-accuracy" class="text-gray-500"></span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">Click anywhere on the map to mark the dumping location</p>
                        
                        <!-- Hidden latitude/longitude fields -->
                        {{ form.latitude }}
                        {{ form.longitude }}
                        
                        {% if form.latitude.errors or form.longitude.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.latitude.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                                {% for error in form.longitude.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-red-600 text-sm mt-1">
                                {% for error in form.description.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="pt-6">
                    <button type="submit" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105">
                        üìç Submit Report to Authorities
                    </button>
                    <p class="text-center text-sm text-gray-500 mt-2">
                        Your report will be immediately sent to the relevant district authorities
                    </p>
                </div>
            </form>
        </div>

        <!-- Quick Tips -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
            <h4 class="font-semibold text-blue-800 mb-2">üí° Quick Tips:</h4>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>‚Ä¢ Take a clear photo showing the dumping site</li>
                <li>‚Ä¢ Click on the map to mark the exact location</li>
                <li>‚Ä¢ Use "My Current Location" for accurate GPS coordinates</li>
                <li>‚Ä¢ Provide as much detail as possible in the description</li>
                <li>‚Ä¢ Authorities will be notified immediately upon submission</li>
            </ul>
        </div>
    </div>
</div>

<!-- Location Help Modal -->
<div id="location-help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-6 max-w-md mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-gray-800">üìç Location Help</h3>
            <button id="close-help-modal" class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        
        <div class="space-y-3">
            <div class="flex items-start">
                <span class="text-blue-500 text-lg mr-2">üó∫Ô∏è</span>
                <div>
                    <p class="font-medium">Click on Map</p>
                    <p class="text-sm text-gray-600">Simply click on the map where the dumping site is located</p>
                </div>
            </div>
            
            <div class="flex items-start">
                <span class="text-green-500 text-lg mr-2">üìç</span>
                <div>
                    <p class="font-medium">Current Location</p>
                    <p class="text-sm text-gray-600">If location access is blocked:</p>
                    <ul class="text-sm text-gray-600 ml-4 mt-1">
                        <li>‚Ä¢ Click the location icon (üìç) in your browser's address bar</li>
                        <li>‚Ä¢ Select "Allow" when prompted</li>
                        <li>‚Ä¢ Refresh the page and try again</li>
                    </ul>
                </div>
            </div>
            
            <div class="flex items-start">
                <span class="text-purple-500 text-lg mr-2">üîç</span>
                <div>
                    <p class="font-medium">Search</p>
                    <p class="text-sm text-gray-600">Use the search box to find specific places or addresses</p>
                </div>
            </div>
        </div>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-600"><strong>Note:</strong> Manual map selection works perfectly if location access is not available!</p>
        </div>
        
        <button id="got-it-btn" class="w-full bg-blue-500 text-white py-2 rounded-md mt-4 hover:bg-blue-600">
            Got it!
        </button>
    </div>
</div>

<!-- Include Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Include Leaflet Geosearch -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />
<script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.umd.js"></script>

<style>
#map { 
    height: 400px; 
    z-index: 1;
}
.leaflet-container {
    font-family: inherit;
    border-radius: 0.5rem;
}
.location-marker {
    background-color: #ef4444;
    border: 3px solid white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.accuracy-circle {
    stroke: #3b82f6;
    stroke-width: 2;
    fill: #3b82f6;
    fill-opacity: 0.1;
}
.leaflet-popup-content {
    font-family: inherit;
}
.search-engine-popup {
    max-width: 300px !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Default to Kampala coordinates
    const defaultLat = 0.3476;
    const defaultLng = 32.5825;
    const defaultZoom = 12;

    // Initialize map
    const map = L.map('map').setView([defaultLat, defaultLng], defaultZoom);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Initialize search control
    const searchControl = new GeoSearch.GeoSearchControl({
        provider: new GeoSearch.OpenStreetMapProvider(),
        style: 'bar',
        searchLabel: 'Search for places in Uganda...',
        showMarker: false,
        autoClose: true,
    });
    map.addControl(searchControl);

    let marker = null;
    let circle = null;
    const latitudeField = document.getElementById('id_latitude');
    const longitudeField = document.getElementById('id_longitude');
    const locationDisplay = document.getElementById('selected-location');
    const accuracyDisplay = document.getElementById('location-accuracy');
    const useCurrentLocationBtn = document.getElementById('use-current-location');
    const resetLocationBtn = document.getElementById('reset-location');
    const locationHelpBtn = document.getElementById('location-help-btn');
    const locationSearch = document.getElementById('location-search');
    const locationHelpModal = document.getElementById('location-help-modal');
    const closeHelpModal = document.getElementById('close-help-modal');
    const gotItBtn = document.getElementById('got-it-btn');

    // Function to update location display
    function updateLocationDisplay(lat, lng, accuracy = null) {
        locationDisplay.textContent = `Latitude: ${lat.toFixed(6)}, Longitude: ${lng.toFixed(6)}`;
        locationDisplay.className = 'text-green-600 font-medium';
        
        if (accuracy !== null) {
            accuracyDisplay.textContent = `Accuracy: ¬±${Math.round(accuracy)} meters`;
        } else {
            accuracyDisplay.textContent = '';
        }
    }

    // Function to set location on map
    function setLocation(lat, lng, accuracy = null) {
        // Update form fields
        latitudeField.value = lat;
        longitudeField.value = lng;
        
        // Update display
        updateLocationDisplay(lat, lng, accuracy);
        
        // Update map view (only zoom if we have good accuracy)
        if (accuracy && accuracy < 1000) {
            map.setView([lat, lng], 16);
        } else if (!marker) {
            map.setView([lat, lng], 16);
        }
        
        // Update or create marker
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            // Create custom marker
            const redIcon = L.divIcon({
                className: 'location-marker',
                html: '',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            marker = L.marker([lat, lng], {icon: redIcon}).addTo(map)
                .bindPopup(`
                    <div class="text-sm">
                        <strong>üìç Dumping Location</strong><br>
                        Lat: ${lat.toFixed(6)}<br>
                        Lng: ${lng.toFixed(6)}<br>
                        ${accuracy ? `Accuracy: ¬±${Math.round(accuracy)}m` : ''}
                    </div>
                `)
                .openPopup();
        }
        
        // Add accuracy circle if available
        if (accuracy && accuracy > 0) {
            if (circle) {
                circle.setLatLng([lat, lng]).setRadius(accuracy);
            } else {
                circle = L.circle([lat, lng], {
                    radius: accuracy,
                    color: '#3b82f6',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    weight: 2,
                    className: 'accuracy-circle'
                }).addTo(map);
            }
        } else if (circle) {
            map.removeLayer(circle);
            circle = null;
        }
    }

    // Handle map clicks
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
        showLocationSuccess('Location selected! Click and drag the marker to adjust if needed.');
    });

    // Handle search results
    map.on('geosearch/showlocation', function(result) {
        setLocation(result.location.y, result.location.x);
        showLocationSuccess(`Location found: ${result.location.label}`);
    });

    // Use current location button
    useCurrentLocationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            showLocationError('Geolocation is not supported by your browser. Please click on the map to select the location.');
            return;
        }

        useCurrentLocationBtn.textContent = 'üîÑ Getting Location...';
        useCurrentLocationBtn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                setLocation(lat, lng, accuracy);
                
                useCurrentLocationBtn.textContent = 'üìç Use My Current Location';
                useCurrentLocationBtn.disabled = false;
                
                showLocationSuccess('Location found successfully!');
            },
            function(error) {
                let errorMessage = 'Unable to get your current location. ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = `
                            üìç Location Access Denied
                            <br><br>
                            To use your current location:
                            <ol class="list-decimal list-inside text-sm space-y-1">
                                <li>Look for the location icon (üìç) in your browser's address bar</li>
                                <li>Click it and select "Allow" location access</li>
                                <li>Refresh this page and try again</li>
                            </ol>
                            <br>
                            <strong>Or simply click on the map to select the location manually!</strong>
                        `;
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information is unavailable. Please click on the map to select the location manually.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out. Please click on the map to select the location manually.';
                        break;
                    default:
                        errorMessage = 'Please click on the map to select the location manually.';
                        break;
                }
                
                showLocationError(errorMessage);
                useCurrentLocationBtn.textContent = 'üìç Use My Current Location';
                useCurrentLocationBtn.disabled = false;
                
                // Show help modal for permission issues
                if (error.code === error.PERMISSION_DENIED) {
                    setTimeout(() => {
                        locationHelpModal.classList.remove('hidden');
                        locationHelpModal.classList.add('flex');
                    }, 1000);
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    });

    // Reset location button
    resetLocationBtn.addEventListener('click', function() {
        setLocation(defaultLat, defaultLng);
        map.setView([defaultLat, defaultLng], defaultZoom);
        showLocationInfo('Location reset to Kampala center');
    });

    // Location help button
    locationHelpBtn.addEventListener('click', function() {
        locationHelpModal.classList.remove('hidden');
        locationHelpModal.classList.add('flex');
    });

    // Close modal events
    closeHelpModal.addEventListener('click', function() {
        locationHelpModal.classList.add('hidden');
        locationHelpModal.classList.remove('flex');
    });

    gotItBtn.addEventListener('click', function() {
        locationHelpModal.classList.add('hidden');
        locationHelpModal.classList.remove('flex');
    });

    // Close modal when clicking outside
    locationHelpModal.addEventListener('click', function(e) {
        if (e.target === locationHelpModal) {
            locationHelpModal.classList.add('hidden');
            locationHelpModal.classList.remove('flex');
        }
    });

    // Show location error as a nice alert
    function showLocationError(message) {
        showAlert(message, 'red');
    }

    function showLocationSuccess(message) {
        showAlert(message, 'green');
    }

    function showLocationInfo(message) {
        showAlert(message, 'blue');
    }

    function showAlert(message, color) {
        // Remove existing alerts
        document.querySelectorAll('.location-alert').forEach(alert => alert.remove());

        const bgColor = {
            'red': 'bg-red-100 border-red-400 text-red-700',
            'green': 'bg-green-100 border-green-400 text-green-700',
            'blue': 'bg-blue-100 border-blue-400 text-blue-700'
        }[color];
        
        const icon = {
            'red': '‚ö†Ô∏è',
            'green': '‚úÖ',
            'blue': '‚ÑπÔ∏è'
        }[color];

        // Create alert div
        const alertDiv = document.createElement('div');
        alertDiv.className = `location-alert fixed top-4 right-4 ${bgColor} border px-6 py-4 rounded-lg shadow-lg z-50 max-w-md transition-all duration-300`;
        alertDiv.innerHTML = `
            <div class="flex items-start">
                <span class="text-lg mr-2 mt-0.5">${icon}</span>
                <div class="flex-1">
                    <div class="flex items-center justify-between">
                        <span class="font-medium">Location Service</span>
                        <button class="ml-4 hover:opacity-70" onclick="this.parentElement.parentElement.parentElement.remove()">
                            &times;
                        </button>
                    </div>
                    <div class="mt-1 text-sm">${message}</div>
                </div>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 8 seconds for errors, 5 for others
        const timeout = color === 'red' ? 8000 : 5000;
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, timeout);
    }

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!latitudeField.value || !longitudeField.value) {
            e.preventDefault();
            showLocationError('Please select a location on the map before submitting your report.');
            // Scroll to map
            document.getElementById('map').scrollIntoView({ 
                behavior: 'smooth',
                block: 'center'
            });
            return false;
        }
    });

    // Set default location immediately
    setLocation(defaultLat, defaultLng);

    // Try to get user's current location on page load (non-blocking)
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // Only use if reasonably accurate and within Uganda
                if (accuracy < 5000 && isWithinUganda(userLat, userLng)) {
                    setLocation(userLat, userLng, accuracy);
                    showLocationSuccess('Automatically detected your location!');
                }
            },
            function(error) {
                // Silent fail - just use default location
                console.log('Auto-location failed, using default Kampala location');
            },
            {
                enableHighAccuracy: false,
                timeout: 3000, // Shorter timeout for page load
                maximumAge: 60000
            }
        );
    }

    // Check if coordinates are within Uganda bounds
    function isWithinUganda(lat, lng) {
        return (-1.5 <= lat && lat <= 4.5 && 29.0 <= lng && lng <= 35.5);
    }
});
</script>
{% endblock %}